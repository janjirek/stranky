---
import Layout from '../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { getCldImageUrl } from 'astro-cloudinary/helpers';
import PageIllustration from '@/components/page-illustration.astro';
import Stripes from '@/assets/images/stripes-dark.svg';
import { Image } from 'astro:assets';
import PhotoGallery from '@/components/photo-gallery';

export const prerender = true;

// Generate static paths for all blog posts
export async function getStaticPaths() {
  // Get all blog entries
  const contractsEntries = await getCollection('contracts');
  return contractsEntries
    .filter(entry => entry.data.slug && typeof entry.data.slug === 'string')
    .map((entry: any) => {
      return {
        params: { contract: entry.data.slug },
        props: { entry },
      };
    });
}

const photoGalleryData = [];
const fullSizeImages = [];

// Get the blog post data from props
const { entry } = Astro.props;
const { Content } = await render(entry);

if (entry.data.images_local) {
  for (const image of entry.data.images_local) {
    photoGalleryData.push({ src: `/${entry.data.slug}/${image}`, width: 600, height: 400 });
    fullSizeImages.push({ src: `/${entry.data.slug}/${image}` });
  }
} else {
  for (const image of entry.data.images) {
    const url = getCldImageUrl({ src: image, width: 600, height: 400 });
    const fullSizeUrl = getCldImageUrl({ src: image });
    photoGalleryData.push({
      src: url,
      width: 600,
      height: 400,
    });
    fullSizeImages.push({
      src: fullSizeUrl,
    });
  }
}

// Sestavení SEO popisku (Odstraněna cena)
const enhancedDescription = `${entry.data.description} | Typ: ${entry.data.type}. Profesionální realitní služby od Ing. Jana Jírka.`;

// Create canonical URL
const canonicalURL = `https://janjirek.cz/zakazky/${entry.data.slug}`;
---

<Layout
  title={entry.data.title}
  description={enhancedDescription}
  image={entry.data.thumbnail_local
    ? `https://janjirek.cz/${entry.data.slug}/${entry.data.thumbnail_local}`
    : getCldImageUrl({ src: entry.data.thumbnail, width: 1200, height: 630 })}
  canonicalURL={canonicalURL}
  type="real-estate"
  publishedTime={entry.data.date.toISOString()}
  modifiedTime={entry.data.date.toISOString()}
  author="Ing. Jan Jírek"
  section="Zakázky"
  tags={entry.data.tags}
>
  <section>
    <PageIllustration />
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <div class="pt-28 pb-8 md:pt-36 md:pb-16">
        {/* DVA SLOUPEC: MAIN A SIDEBAR */}
        <div class="md:grid md:grid-cols-12 md:gap-10">
          {/* PRAVÝ SLOUPEC: STICKY SIDEBAR (Nyní s panelem pro výsledek a kontakt) */}
          <aside class="md:col-span-4 mt-12 md:mt-0 md:order-1">
            <div data-sticky data-sticky-for="991" data-margin-top="100">
              {/* Box výsledku a CTA */}
              <div
                class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700"
              >
                {/* VÝZVA A POPIS - Pouze toto zůstává nahoře */}
                <div class="text-center mb-6">
                  <h3
                    class="text-xl font-extrabold text-slate-900 dark:text-white mb-3 border-b pb-3 border-gray-200 dark:border-gray-700"
                  >
                    Zajímá vás, jak to proběhlo?
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    Tato zakázka byla úspěšně realizována. Prohlédněte si detaily.
                  </p>
                </div>

                {/* TLAČÍTKO KONTAKT */}
                <a
                  class="btn w-full text-white bg-blue-600 hover:bg-blue-700 group shadow-lg px-6 py-3 rounded-xl justify-center text-center"
                  href="/kontakt"
                >
                  Chci podobnou prezentaci
                  <span
                    class="tracking-normal text-indigo-200 group-hover:translate-x-0.5 transition-transform duration-150 ease-in-out ml-1"
                    >-></span
                  >
                </a>

                {/* ODKAZ ZPĚT */}
                <a
                  class="block mt-4 text-center text-sm font-medium text-blue-500 transition-colors hover:text-blue-600"
                  href="/zakazky"
                >
                  Zpět na přehled zakázek
                </a>
              </div>
            </div>
          </aside>

          {/* LEVÝ SLOUPEC: OBSAH (8/12 = cca 66%) */}
          <div class="md:col-span-8 md:order-0">
            <div class="pb-8">
              {/* TITULEK NEMOVITOSTI */}
              <h1 class="text-4xl font-extrabold font-cabinet-grotesk mb-10">{entry.data.title}</h1>

              {/* PŮVODNÍ MD OBSAH */}
              <div
                class="prose md:prose-lg prose-img:rounded-xl prose-img:shadow-lg prose-headings:font-bold prose-headings:text-gray-900 prose-a:font-medium prose-a:text-blue-500 prose-a:no-underline hover:prose-a:underline prose-blockquote:border-l-2 prose-blockquote:border-gray-300 prose-blockquote:pl-4 prose-blockquote:font-medium prose-blockquote:italic prose-blockquote:text-gray-900 prose-strong:font-bold prose-strong:text-gray-900 prose-code:rounded prose-code:bg-transparent prose-code:px-1 prose-code:py-0.5 prose-code:font-mono prose-code:text-gray-900 prose-code:before:content-[''] prose-code:after:content-[''] prose-pre:border prose-pre:border-gray-700 prose-pre:bg-gray-900 prose-blockquote:xl:-ml-4"
              >
                <Content />
              </div>
            </div>
          </div>
        </div>
        <hr class="mt-8 mb-14" />

        {/* Galerie a YouTube */}
        <section>
          <div class="mx-auto max-w-6xl px-4 sm:px-6">
            <div
              class="relative overflow-hidden rounded-2xl text-center shadow-xl before:pointer-events-none before:absolute before:inset-0 before:-z-10 before:rounded-2xl before:bg-gray-900"
              data-aos="zoom-y-out"
            >
              {/* Glow a Stripes - Zachováno */}
              <div
                class="absolute bottom-0 left-1/2 -z-10 -translate-x-1/2 translate-y-1/2"
                aria-hidden="true"
              >
                <div
                  class="h-56 w-[480px] rounded-full border-[20px] border-blue-500 blur-3xl will-change-[filter]"
                >
                </div>
              </div>
              <div
                class="pointer-events-none absolute left-1/2 top-0 -z-10 -translate-x-1/2 transform"
                aria-hidden="true"
              >
                <Image class="max-w-none" src={Stripes} alt="Stripes" />
              </div>

              <div class="px-4 py-12 md:px-12 md:py-20">
                <h2
                  class="mb-6 border-y text-3xl font-bold text-gray-200 [border-image:linear-gradient(to_right,transparent,--theme(--color-slate-700/.7),transparent)1] md:mb-12 md:text-4xl"
                >
                  Galerie
                </h2>
                <div class="mx-auto max-w-xs sm:flex sm:max-w-none sm:justify-center">
                  <div class="flex flex-col gap-4 w-full">
                    {/* YouTube Video (podmíněný rendering) */}
                    {
                      entry.data.youtube_link && (
                        <div class="bg-gray-100 rounded-lg p-2 self-center w-full">
                          <iframe
                            class="responsive-iframe"
                            width="100%"
                            height="100%"
                            src={entry.data.youtube_link}
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen
                          />
                        </div>
                      )
                    }
                    {/* Foto Galerie */}
                    <div>
                      <PhotoGallery
                        images={photoGalleryData}
                        fullSizeImages={fullSizeImages}
                        client:load
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>
</Layout>

<script>
  // @ts-ignore
  import Sticky from 'sticky-js';
  const sticky = new Sticky('[data-sticky]');
</script>

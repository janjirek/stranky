---
import Layout from '../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { getCldImageUrl } from 'astro-cloudinary/helpers';
import PageIllustration from '@/components/page-illustration.astro';
import { Icon } from 'astro-icon/components'; 
import Stripes from '@/assets/images/stripes-dark.svg';
import { Image } from 'astro:assets';
import PhotoGallery from '@/components/photo-gallery'; 

export const prerender = true;

// üî• KL√çƒåOV√Å OPRAVA: ZAJI≈†TƒöN√ç INTEGRITY DAT V getStaticPaths
export async function getStaticPaths() {
  const estateEntries = await getCollection('catalogue');
  
  return estateEntries
    // 1. D≈Øle≈æit√Ω filtr: Zabr√°n√≠ chybƒõ, pokud nƒõkter√Ω MD soubor nem√° 'slug' v frontmatteru
    .filter(entry => entry.data.slug && typeof entry.data.slug === 'string') 
    .map((entry: any) => {
      return {
        // Kl√≠ƒç parametru mus√≠ odpov√≠dat n√°zvu souboru [estate].astro
        params: { estate: entry.data.slug }, 
        props: { entry },
      };
    });
}

// Z√≠sk√°n√≠ dat
const { entry } = Astro.props;
const { Content } = await render(entry);

// Dynamick√© sestaven√≠ galerie
const photoGalleryData = [];
const fullSizeImages = [];
// Pou≈æ√≠v√°me kontrolu, aby k√≥d neshodil build, pokud je pole images pr√°zdn√©
if (Array.isArray(entry.data.images)) {
    for (const image of entry.data.images) {
      const url = getCldImageUrl({ src: image, width: 600, height: 400 });
      const fullSizeUrl = getCldImageUrl({ src: image });
      photoGalleryData.push({ src: url, width: 600, height: 400 });
      fullSizeImages.push({ src: fullSizeUrl });
    }
}

// Bezpeƒçn√© sestaven√≠ SEO popisku (odstranƒõna chyba 'mƒõs√≠ƒçnƒõ' u prodeje)
const priceSuffix = entry.data.type.toLowerCase() === 'pron√°jem' ? ' mƒõs√≠ƒçnƒõ' : '';
const enhancedDescription = `${entry.data.description} | Typ: ${entry.data.type} v ${entry.data.location.split(',')[0]}. Cena: ${entry.data.price} ${priceSuffix}. Profesion√°ln√≠ realitn√≠ slu≈æby od Ing. Jana J√≠rka.`;

// P≈ôejmenov√°n√≠ kv≈Øli syntaxi
const propertyDetails = {
    type: entry.data.type,
    location: entry.data.location,
    price: entry.data.price,
    propertyType: entry.data.type || 'Prodej',
};

// Create canonical URL
const canonicalURL = `https://janjirek.cz/${entry.data.slug}`;
---

<Layout
  title={entry.data.title}
  description={enhancedDescription}
  image={getCldImageUrl({ src: entry.data.thumbnail, width: 1200, height: 630 })}
  canonicalURL={canonicalURL}
  type="real-estate"
  publishedTime={entry.data.date.toISOString()}
  modifiedTime={entry.data.date.toISOString()}
  author="Ing. Jan J√≠rek"
  section="Nab√≠dka Nemovitost√≠"
  tags={entry.data.tags}
  propertyType={propertyDetails.propertyType}
  location={propertyDetails.location}
  price={propertyDetails.price}
>
  <section>
    <PageIllustration />
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <div class="pt-28 pb-8 md:pt-36 md:pb-16">
        
        {/* HLAVN√ç OBSAH */}
        <div class="md:flex md:justify-between">
          
          <div class="md:grow">
            
            {/* Zpƒõt na katalog odkaz */}
            <div class="pb-8">
              <div class="mb-4">
                <a
                  class="text-sm font-medium text-blue-500 transition-colors hover:text-blue-600"
                  href="/nemovitosti"
                >
                  <span class="tracking-normal text-blue-300">&lt;-</span>{' '}
                  Zpƒõt na katalog nemovitost√≠
                </a>
              </div>
              
              {/* TITULEK NEMOVITOSTI */}
              <h1 class="text-4xl font-extrabold font-cabinet-grotesk mb-6">{entry.data.title}</h1>

              {/* SEKCE DETAILY & CTA (Modern√≠ li≈°ta) */}
              <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-5 mb-8 shadow-sm border border-gray-200 dark:border-gray-700 md:flex md:justify-between md:items-center">
                  
                  {/* CENA A LOKALITA */}
                  <div class="mb-4 md:mb-0">
                      <p class="text-xs uppercase font-medium text-gray-500 dark:text-gray-400 mb-1">
                          {entry.data.location}
                      </p>
                      <span class="text-3xl font-extrabold text-blue-600 dark:text-blue-400 font-cabinet-grotesk">
                          {entry.data.price}
                      </span>
                  </div>

                  {/* TLAƒå√çTKO KONTAKT */}
                  <div class="w-full md:w-auto">
                    <a
                      class="btn w-full md:w-auto text-white bg-blue-600 hover:bg-blue-700 group shadow-lg px-6 py-3 rounded-xl"
                      href="/kontakt"
                    >
                      Kontaktovat makl√©≈ôe
                      <span
                        class="tracking-normal text-indigo-200 group-hover:translate-x-0.5 transition-transform duration-150 ease-in-out ml-1"
                      >
                        ->
                      </span>
                    </a>
                  </div>

              </div>
              {/* Konec CTA boxu */}

              {/* P≈ÆVODN√ç MD OBSAH */}
              <div
                class="prose md:prose-lg prose-img:rounded-xl prose-img:shadow-lg prose-headings:font-bold prose-headings:text-gray-900 prose-a:font-medium prose-a:text-blue-500 prose-a:no-underline hover:prose-a:underline prose-blockquote:border-l-2 prose-blockquote:border-gray-300 prose-blockquote:pl-4 prose-blockquote:font-medium prose-blockquote:italic prose-blockquote:text-gray-900 prose-strong:font-bold prose-strong:text-gray-900 prose-code:rounded prose-code:bg-transparent prose-code:px-1 prose-code:py-0.5 prose-code:font-mono prose-code:text-gray-900 prose-code:before:content-[''] prose-code:after:content-[''] prose-pre:border prose-pre:border-gray-700 prose-pre:bg-gray-900 prose-blockquote:xl:-ml-4"
              >
                <Content />
              </div>
            </div>
          </div>
          
          {/* P≈Øvodn√≠ Sidebar/Aside je ZRU≈†EN */}
        </div>
        <hr class="mt-8 mb-14" />
        
        {/* Galerie a YouTube */}
        <section>
          <div class="mx-auto max-w-6xl px-4 sm:px-6">
            <div
              class="relative overflow-hidden rounded-2xl text-center shadow-xl before:pointer-events-none before:absolute before:inset-0 before:-z-10 before:rounded-2xl before:bg-gray-900"
              data-aos="zoom-y-out"
            >
              
              {/* Glow a Stripes - Zachov√°no */}
              <div
                class="absolute bottom-0 left-1/2 -z-10 -translate-x-1/2 translate-y-1/2"
                aria-hidden="true"
              >
                <div
                  class="h-56 w-[480px] rounded-full border-[20px] border-blue-500 blur-3xl will-change-[filter]"
                >
                </div>
              </div>
              <div
                class="pointer-events-none absolute left-1/2 top-0 -z-10 -translate-x-1/2 transform"
                aria-hidden="true"
              >
                <Image class="max-w-none" src={Stripes} alt="Stripes" />
              </div>

              <div class="px-4 py-12 md:px-12 md:py-20">
                <h2
                  class="mb-6 border-y text-3xl font-bold text-gray-200 [border-image:linear-gradient(to_right,transparent,--theme(--color-slate-700/.7),transparent)1] md:mb-12 md:text-4xl"
                >
                  Galerie
                </h2>
                <div class="mx-auto max-w-xs sm:flex sm:max-w-none sm:justify-center">
                  <div class="flex flex-col gap-4 w-full">
                    {/* YouTube Video (podm√≠nƒõn√Ω rendering) */}
                    {
                      entry.data.youtube_link && (
                        <div class="bg-gray-100 rounded-lg p-2 self-center w-full">
                          <iframe
                            class="responsive-iframe"
                            width="100%"
                            height="100%"
                            src={entry.data.youtube_link}
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen
                          />
                        </div>
                      )
                    }
                    {/* Foto Galerie */}
                    <div>
                      <PhotoGallery
                        images={photoGalleryData}
                        fullSizeImages={fullSizeImages}
                        client:load
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>
</Layout>
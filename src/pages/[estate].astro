---
import Layout from '../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { getCldImageUrl } from 'astro-cloudinary/helpers';
import PageIllustration from '@/components/page-illustration.astro';
import { Icon } from 'astro-icon/components';
import Stripes from '@/assets/images/stripes-dark.svg';
import { Image } from 'astro:assets';
import PhotoGallery from '@/components/photo-gallery';

export const prerender = true;

export async function getStaticPaths() {
  const estateEntries = await getCollection('catalogue');

  return estateEntries
    // Bezpečnostní filtr, aby build nepadal
    .filter(entry => entry.data.slug && typeof entry.data.slug === 'string')
    .map((entry: any) => {
      return {
        params: { estate: entry.data.slug },
        props: { entry },
      };
    });
}

// Get the estate data from props
const { entry } = Astro.props;
const { Content } = await render(entry);

// Dynamické sestavení galerie
const photoGalleryData = [];
const fullSizeImages = [];
if (Array.isArray(entry.data.images)) {
  for (const image of entry.data.images) {
    const url = getCldImageUrl({ src: image, width: 600, height: 400 });
    const fullSizeUrl = getCldImageUrl({ src: image });
    photoGalleryData.push({ src: url, width: 600, height: 400 });
    fullSizeImages.push({ src: fullSizeUrl });
  }
}

// Sestavení SEO popisku
const propertyDetails = {
    type: entry.data.type,
    location: entry.data.location,
    price: entry.data.price,
    propertyType: entry.data.type || 'Prodej',
};

const priceSuffix = entry.data.type.toLowerCase() === 'pronájem' ? ' měsíčně' : '';
const enhancedDescription = `${entry.data.description} | Typ: ${entry.data.type} v ${entry.data.location.split(',')[0]}. Cena: ${entry.data.price} ${priceSuffix}. Profesionální realitní služby od Ing. Jana Jírka.`;

// Create canonical URL
const canonicalURL = `https://janjirek.cz/${entry.data.slug}`;
---

<Layout
  title={entry.data.title}
  description={enhancedDescription}
  image={getCldImageUrl({ src: entry.data.thumbnail, width: 1200, height: 630 })}
  canonicalURL={canonicalURL}
  type="real-estate"
  publishedTime={entry.data.date.toISOString()}
  modifiedTime={entry.data.date.toISOString()}
  author="Ing. Jan Jírek"
  section="Nabídka Nemovitostí"
  tags={entry.data.tags}
  propertyType={propertyDetails.propertyType}
  location={propertyDetails.location}
  price={propertyDetails.price}
>
  <section>
    <PageIllustration />
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <div class="pt-28 pb-8 md:pt-36 md:pb-16">

        <div class="md:grid md:grid-cols-12 md:gap-10">

          <div class="md:col-span-8">

            {/* Zpět na katalog odkaz */}
            <div class="pb-8">
              <div class="mb-4">
                <a
                  class="text-sm font-medium text-blue-500 transition-colors hover:text-blue-600"
                  href="/nemovitosti"
                >
                  <span class="tracking-normal text-blue-300">&lt;-</span>{' '}
                  Zpět na katalog nemovitostí
                </a>
              </div>

              {/* TITULEK NEMOVITOSTI */}
              <h1 class="text-4xl font-extrabold font-cabinet-grotesk mb-6">{entry.data.title}</h1>

              {/* PŮVODNÍ MD OBSAH */}
              <div
                class="prose md:prose-lg prose-img:rounded-xl prose-img:shadow-lg prose-headings:font-bold prose-headings:text-gray-900 prose-a:font-medium prose-a:text-blue-500 prose-a:no-underline hover:prose-a:underline prose-blockquote:border-l-2 prose-blockquote:border-gray-300 prose-blockquote:pl-4 prose-blockquote:font-medium prose-blockquote:italic prose-blockquote:text-gray-900 prose-strong:font-bold prose-strong:text-gray-900 prose-code:rounded prose-code:bg-transparent prose-code:px-1 prose-code:py-0.5 prose-code:font-mono prose-code:text-gray-900 prose-code:before:content-[''] prose-code:after:content-[''] prose-pre:border prose-pre:border-gray-700 prose-pre:bg-gray-900 prose-blockquote:xl:-ml-4"
              >
                <Content />
              </div>
            </div>
          </div>

          <aside class="md:col-span-4 mt-12 md:mt-0">
              <div data-sticky data-sticky-for="991" data-margin-top="100">
                  {/* Box se základním infem a CTA */}
                  <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700">
                      <h3 class="text-xl font-extrabold text-slate-900 dark:text-white mb-4 border-b pb-3 border-gray-200 dark:border-gray-700">Základní informace</h3>

                      {/* CENA */}
                      <div class="mb-4">
                          <p class="text-xs uppercase font-medium text-gray-500 dark:text-gray-400 mb-1">Cena</p>
                          <span class="text-3xl font-extrabold text-blue-600 dark:text-blue-400 font-cabinet-grotesk">
                              {entry.data.price}
                          </span>
                      </div>

                      {/* LOKALITA - FIX: Nyní klikatelný odkaz na mapy */}
                      <div class="mb-6">
                          <p class="text-xs uppercase font-medium text-gray-500 dark:text-gray-400 mb-1">Lokalita</p>
                          <a 
                            href={entry.data.mapy_link} 
                            target="_blank" 
                            rel="noopener noreferrer" 
                            class="text-lg font-bold text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors flex items-center group"
                          >
                            {entry.data.location}
                            {/* Ikona šipky pro indikaci externího odkazu */}
                            <svg class="w-4 h-4 ml-2 mt-0.5 text-blue-400 dark:text-blue-300 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                          </a>
                      </div>
                      
                      {/* TLAČÍTKO KONTAKT */}
                      <a
                          class="btn w-full text-white bg-blue-600 hover:bg-blue-700 group shadow-lg px-6 py-3 rounded-xl justify-center text-center"
                          href="/kontakt"
                      >
                          Kontaktovat makléře
                          <span class="tracking-normal text-indigo-200 group-hover:translate-x-0.5 transition-transform duration-150 ease-in-out ml-1">-></span>
                      </a>
                  </div>
              </div>
          </aside>
        </div>
        <hr class="mt-8 mb-14" />

        {/* Galerie a YouTube */}
        <section>
          <div class="mx-auto max-w-6xl px-4 sm:px-6">
            <div
              class="relative overflow-hidden rounded-2xl text-center shadow-xl before:pointer-events-none before:absolute before:inset-0 before:-z-10 before:rounded-2xl before:bg-gray-900"
              data-aos="zoom-y-out"
            >
              <div
                class="absolute bottom-0 left-1/2 -z-10 -translate-x-1/2 translate-y-1/2"
                aria-hidden="true"
              >
                <div
                  class="h-56 w-[480px] rounded-full border-[20px] border-blue-500 blur-3xl will-change-[filter]"
                >
                </div>
              </div>
              <div
                class="pointer-events-none absolute left-1/2 top-0 -z-10 -translate-x-1/2 transform"
                aria-hidden="true"
              >
                <Image class="max-w-none" src={Stripes} alt="Stripes" />
              </div>

              <div class="px-4 py-12 md:px-12 md:py-20">
                <h2
                  class="mb-6 border-y text-3xl font-bold text-gray-200 [border-image:linear-gradient(to_right,transparent,--theme(--color-slate-700/.7),transparent)1] md:mb-12 md:text-4xl"
                >
                  Galerie
                </h2>
                <div class="mx-auto max-w-xs sm:flex sm:max-w-none sm:justify-center">
                  <div class="flex flex-col gap-4 w-full">
                    {/* YouTube Video (podmíněný rendering) */}
                    {
                      entry.data.youtube_link && (
                        <div class="bg-gray-100 rounded-lg p-2 self-center w-full">
                          <iframe
                            class="responsive-iframe"
                            width="100%"
                            height="100%"
                            src={entry.data.youtube_link}
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen
                          />
                        </div>
                      )
                    }
                    {/* Foto Galerie */}
                    <div>
                      <PhotoGallery
                        images={photoGalleryData}
                        fullSizeImages={fullSizeImages}
                        client:load
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>
</Layout>

<script>
  // @ts-ignore
  import Sticky from 'sticky-js';
  const sticky = new Sticky('[data-sticky]');
</script>